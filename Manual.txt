//Procedimiento almacenado para PRESTAR EQUIPO

CREATE OR REPLACE PROCEDURE loan_equipment(
  p_student_email VARCHAR,
  p_equipment_id INT,
  p_quantity INT
)
LANGUAGE plpgsql
AS $$
BEGIN
  -- Verificar disponibilidad
  IF (SELECT available_quantity FROM equipments WHERE id = p_equipment_id) < p_quantity THEN
    RAISE EXCEPTION 'No hay equipos disponibles';
  END IF;

  -- Registrar préstamo
  INSERT INTO loans (student_email, equipment_id, quantity, loan_date, status)
  VALUES (p_student_email, p_equipment_id, p_quantity, CURRENT_DATE, 'ACTIVE');

  -- Actualizar stock
  UPDATE equipments
  SET available_quantity = available_quantity - p_quantity
  WHERE id = p_equipment_id;
END;
$$;

uso
CALL loan_equipment('luis@mail.com', 1, 1);

//procedimiento almacenado para devolver 
CREATE OR REPLACE PROCEDURE return_equipment(
  p_loan_id INT,
  p_student_email VARCHAR
)
LANGUAGE plpgsql
AS $$
DECLARE
  v_equipment_id INT;
  v_quantity INT;
BEGIN
  -- Verificar que el préstamo pertenece al usuario
  SELECT equipment_id, quantity
  INTO v_equipment_id, v_quantity
  FROM loans
  WHERE id = p_loan_id
    AND student_email = p_student_email
    AND status = 'ACTIVE';

  IF NOT FOUND THEN
    RAISE EXCEPTION 'Préstamo no encontrado, ya devuelto o no pertenece al usuario';
  END IF;

  -- Marcar devolución
  UPDATE loans
  SET status = 'RETURNED',
      return_date = CURRENT_DATE
  WHERE id = p_loan_id;

  -- Actualizar stock
  UPDATE equipments
  SET available_quantity = available_quantity + v_quantity
  WHERE id = v_equipment_id;
END;
$$;

//uso 
ID del préstamo
el usuario 
CALL return_equipment(5, 'luis@mail.com');


//procedimiento HISTORIAL COMPLETO DE UN USUARIO
CREATE OR REPLACE FUNCTION user_loan_history(
  p_student_email VARCHAR
)
RETURNS TABLE (
  loan_id INT,
  equipment_name VARCHAR,
  quantity INT,
  loan_date DATE,
  return_date DATE,
  status VARCHAR
)
LANGUAGE plpgsql
AS $$
BEGIN
  RETURN QUERY
  SELECT
    l.id,
    e.name,
    l.quantity,
    l.loan_date,
    l.return_date,
    l.status
  FROM loans l
  JOIN equipments e ON e.id = l.equipment_id
  WHERE l.student_email = p_student_email
  ORDER BY l.loan_date DESC;
END;
$$;

//uso 
SELECT * FROM user_loan_history('ana@mail.com');

